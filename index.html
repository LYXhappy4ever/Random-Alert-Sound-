<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨èƒ½ä¸“æ³¨ç»ˆç«¯ (ä¿®å¤ç‰ˆ)</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ§ </text></svg>">
    
    <style>
        :root {
            --bg-focus: #2c3e50;     /* æ·±è“ï¼šä¸“æ³¨/æ­£è®¡æ—¶ */
            --bg-overtime: #d35400;  /* æ©™çº¢ï¼šè¶…æ—¶/ç›®æ ‡è¾¾æˆ */
            --bg-rest: #27ae60;      /* ç»¿è‰²ï¼šå¾®ä¼‘æ¯/å€’è®¡æ—¶ */
            --bg-long-rest: #8e44ad; /* ç´«è‰²ï¼šå¤§ä¼‘æ¯ */
            --text-color: #ecf0f1;
            --panel-bg: rgba(0, 0, 0, 0.4);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-focus);
            color: var(--text-color);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: background-color 0.6s ease;
            overflow: hidden;
            user-select: none;
        }

        .container {
            text-align: center;
            width: 100%;
            max-width: 600px;
            padding: 20px;
            box-sizing: border-box;
            position: relative;
        }

        /* é¡¶éƒ¨å·¥å…·æ  */
        .toolbar {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
        }
        
        .btn-icon {
            background: none;
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            opacity: 0.7;
        }
        .btn-icon:hover { opacity: 1; background: rgba(255,255,255,0.1); }

        /* è®¾ç½®é¢æ¿ */
        .settings-panel {
            background: var(--panel-bg);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            text-align: left;
            transition: all 0.3s ease;
            overflow: hidden;
            max-height: 600px;
            opacity: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .settings-panel.collapsed {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-bottom: 0;
            opacity: 0;
            pointer-events: none;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .input-group { display: flex; flex-direction: column; }
        .input-group label { font-size: 12px; opacity: 0.8; margin-bottom: 5px; }
        .input-group input, .input-group select {
            padding: 10px;
            border-radius: 8px;
            border: none;
            background: rgba(255,255,255,0.9);
            font-size: 16px;
            color: #333;
            outline: none;
        }
        .full-width { grid-column: span 2; }
        .hidden { display: none !important; }

        /* è®¡æ—¶æ˜¾ç¤ºåŒº */
        .timer-display {
            margin-top: 20px;
            margin-bottom: 40px;
        }

        h1#main-timer {
            font-size: 120px;
            margin: 0;
            font-weight: 200;
            font-variant-numeric: tabular-nums;
            line-height: 1;
            letter-spacing: -2px;
            text-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        h2#status-text {
            font-size: 32px;
            margin: 10px 0;
            font-weight: 600;
            min-height: 1.2em;
        }

        p#sub-info {
            font-size: 18px;
            opacity: 0.6;
            margin-top: 10px;
            min-height: 1.2em;
        }

        /* æŒ‰é’®åŒº */
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 20px;
        }

        .controls button {
            padding: 18px 50px;
            font-size: 20px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.3s;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            min-width: 200px;
        }

        .btn-start { background-color: #fff; color: #333; }
        .btn-start:hover { background-color: #f0f0f0; }
        
        .btn-break { 
            background-color: #f1c40f; 
            color: #2c3e50; 
            animation: pulse 2s infinite;
            display: none; 
        }
        
        .btn-reset { 
            background: none; 
            color: rgba(255,255,255,0.6); 
            box-shadow: none; 
            padding: 10px;
            font-size: 14px;
            min-width: auto;
        }
        .btn-reset:hover { color: #fff; text-decoration: underline; }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(241, 196, 15, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(241, 196, 15, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(241, 196, 15, 0); }
        }

    </style>
</head>
<body>

    <div class="toolbar">
        <button class="btn-icon" onclick="toggleSettings()" id="btn-settings-toggle">æ”¶èµ·è®¾ç½®</button>
    </div>

    <div class="container">
        <div class="settings-panel" id="settings-box">
            
            <div class="input-group">
                <label>é€‰æ‹©æ¨¡å¼</label>
                <select id="mode-select" onchange="changeMode()">
                    <option value="RANDOM">ğŸ§  éšæœºä¸“æ³¨ (æ ¸å¿ƒåŠŸèƒ½)</option>
                    <option value="COUNTDOWN">â³ çº¯å€’è®¡æ—¶ (Timer)</option>
                    <option value="STOPWATCH">â±ï¸ çº¯æ­£è®¡æ—¶ (Stopwatch)</option>
                </select>
            </div>

            <div class="input-row" id="setting-random">
                <div class="input-group">
                    <label>ä¸“æ³¨æ—¶é•¿ (åˆ†é’Ÿ)</label>
                    <input type="number" id="input-random-total" value="90">
                </div>
                <div class="input-group">
                    <label>å¤§ä¼‘æ¯æ—¶é•¿ (åˆ†é’Ÿ)</label>
                    <input type="number" id="input-random-rest" value="20">
                </div>
                <div class="input-group">
                    <label>éšæœºæœ€å°é—´éš” (åˆ†é’Ÿ)</label>
                    <input type="number" id="input-min" value="3">
                </div>
                <div class="input-group">
                    <label>éšæœºæœ€å¤§é—´éš” (åˆ†é’Ÿ)</label>
                    <input type="number" id="input-max" value="5">
                </div>
                <div class="input-group full-width">
                    <label>å¾®ä¼‘æ¯æ—¶é•¿ (ç§’)</label>
                    <input type="number" id="input-micro" value="10">
                </div>
            </div>

            <div class="input-row hidden" id="setting-countdown">
                <div class="input-group full-width">
                    <label>å€’è®¡æ—¶æ—¶é•¿ (åˆ†é’Ÿ)</label>
                    <input type="number" id="input-countdown-total" value="20">
                </div>
            </div>

            <div class="input-row hidden" id="setting-stopwatch">
                <div class="input-group full-width">
                    <label>æ­£è®¡æ—¶ç›®æ ‡æé†’ (åˆ†é’Ÿ)</label>
                    <input type="number" id="input-stopwatch-target" value="90">
                </div>
            </div>

        </div>

        <div class="timer-display">
            <h2 id="status-text">å‡†å¤‡å¼€å§‹</h2>
            <h1 id="main-timer">00:00</h1>
            <p id="sub-info">é€‰æ‹©æ¨¡å¼å¹¶å¼€å§‹</p>
        </div>

        <div class="controls">
            <button class="btn-start" id="btn-toggle" onclick="toggleTimer()">å¼€å§‹</button>
            <button class="btn-break" id="btn-end-session" onclick="finishSession()">â¹ ç»“æŸå¹¶æŸ¥çœ‹æ—¶é•¿</button>
            <button class="btn-reset" onclick="resetTimer()">é‡ç½®æ‰€æœ‰</button>
        </div>
    </div>

    <script id="worker-code" type="javascript/worker">
        let timerID = null;
        self.onmessage = function(e) {
            if (e.data === 'start') {
                if (timerID) clearInterval(timerID);
                timerID = setInterval(function() {
                    self.postMessage('tick');
                }, 1000);
            } else if (e.data === 'stop') {
                if (timerID) clearInterval(timerID);
                timerID = null;
            }
        };
    </script>

    <script>
        // --- æ ¸å¿ƒï¼šåˆ›å»º Web Worker (é˜²æ­¢åå°å˜æ…¢) ---
        const workerBlob = new Blob([document.getElementById('worker-code').textContent], {type: "text/javascript"});
        const worker = new Worker(window.URL.createObjectURL(workerBlob));
        let wakeLock = null; // å±å¹•å¸¸äº®å¥æŸ„

        // --- å…¨å±€å˜é‡ ---
        let isRunning = false;
        let currentMode = 'RANDOM';
        let currentState = 'IDLE'; 

        // æ—¶é—´å˜é‡ (ç§’)
        let mainTime = 0;       
        let totalDuration = 0;  
        let eventTimeLeft = 0;  
        let targetTime = 0;     
        
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let activeOscillators = [];

        // --- åˆå§‹åŒ– UI ---
        window.onload = function() {
            changeMode();
            
            // ç»‘å®š Worker æ¶ˆæ¯
            worker.onmessage = function(e) {
                if (e.data === 'tick') {
                    tick();
                }
            };
        };

        // --- å±å¹•å¸¸äº®æ§åˆ¶ ---
        async function requestWakeLock() {
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log('å±å¹•å¸¸äº®å·²å¼€å¯');
                wakeLock.addEventListener('release', () => {
                    console.log('å±å¹•å¸¸äº®å·²é‡Šæ”¾');
                });
            } catch (err) {
                console.log('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒæˆ–æ‹’ç»äº†å±å¹•å¸¸äº®:', err.name, err.message);
            }
        }

        function releaseWakeLock() {
            if (wakeLock !== null) {
                wakeLock.release();
                wakeLock = null;
            }
        }

        function changeMode() {
            currentMode = document.getElementById('mode-select').value;
            
            document.getElementById('setting-random').classList.add('hidden');
            document.getElementById('setting-countdown').classList.add('hidden');
            document.getElementById('setting-stopwatch').classList.add('hidden');

            let defaultTimeStr = "00:00";

            if (currentMode === 'RANDOM') {
                document.getElementById('setting-random').classList.remove('hidden');
                defaultTimeStr = formatTime(document.getElementById('input-random-total').value * 60);
                document.getElementById('status-text').innerText = "ğŸ§  éšæœºä¸“æ³¨æ¨¡å¼";
            } else if (currentMode === 'COUNTDOWN') {
                document.getElementById('setting-countdown').classList.remove('hidden');
                defaultTimeStr = formatTime(document.getElementById('input-countdown-total').value * 60);
                document.getElementById('status-text').innerText = "â³ çº¯å€’è®¡æ—¶æ¨¡å¼";
            } else if (currentMode === 'STOPWATCH') {
                document.getElementById('setting-stopwatch').classList.remove('hidden');
                defaultTimeStr = "00:00";
                document.getElementById('status-text').innerText = "â±ï¸ çº¯æ­£è®¡æ—¶æ¨¡å¼";
            }

            document.getElementById('main-timer').innerText = defaultTimeStr;
            resetTimerUI();
        }

        // --- æ ¸å¿ƒè®¡æ—¶é€»è¾‘ ---
        function toggleTimer() {
            const btn = document.getElementById('btn-toggle');
            
            if (isRunning) {
                // æš‚åœ
                worker.postMessage('stop'); // åœæ­¢ Worker
                releaseWakeLock(); // é‡Šæ”¾å¸¸äº®
                isRunning = false;
                btn.innerText = "ç»§ç»­";
                document.getElementById('sub-info').innerText = "å·²æš‚åœ";
                stopAllSounds();
            } else {
                // å¼€å§‹
                if (audioCtx.state === 'suspended') audioCtx.resume();
                requestWakeLock(); // è¯·æ±‚å¸¸äº®

                if (currentState === 'IDLE') {
                    initStart();
                }

                isRunning = true;
                btn.innerText = (currentState === 'OVERTIME') ? "ç»§ç»­è¶…æ—¶ç»Ÿè®¡" : "æš‚åœ";
                worker.postMessage('start'); // å¯åŠ¨ Worker
            }
        }

        function initStart() {
            currentState = 'RUNNING';
            totalDuration = 0;
            
            if (currentMode === 'RANDOM') {
                mainTime = document.getElementById('input-random-total').value * 60;
                eventTimeLeft = getRandomInterval();
                setStyle('FOCUS');
            } else if (currentMode === 'COUNTDOWN') {
                mainTime = document.getElementById('input-countdown-total').value * 60;
                setStyle('REST'); 
            } else if (currentMode === 'STOPWATCH') {
                mainTime = 0; 
                targetTime = document.getElementById('input-stopwatch-target').value * 60;
                setStyle('FOCUS');
            }

            if (!document.getElementById('settings-box').classList.contains('collapsed')) {
                toggleSettings();
            }
            document.getElementById('btn-end-session').style.display = 'none';
            document.getElementById('btn-toggle').style.display = 'inline-block';
            updateDisplay();
        }

        function tick() {
            // è¿™ä¸ªå‡½æ•°ç°åœ¨ç”± Web Worker æ¯ç§’è°ƒç”¨ä¸€æ¬¡ï¼Œè€Œä¸æ˜¯ setInterval
            
            // 1. éšæœºä¸“æ³¨æ¨¡å¼é€»è¾‘
            if (currentMode === 'RANDOM') {
                if (currentState === 'RUNNING' || currentState === 'OVERTIME') {
                    eventTimeLeft--;
                    totalDuration++;
                    
                    if (eventTimeLeft <= 0) {
                        triggerMicroRest();
                        return;
                    }
                }

                if (currentState === 'MICRO_REST') {
                    eventTimeLeft--;
                    if (eventTimeLeft <= 0) {
                        triggerFocusReturn();
                    }
                    updateDisplay();
                    return;
                }

                if (currentState === 'RUNNING') {
                    mainTime--;
                    if (mainTime <= 0) {
                        triggerAlarmAndOvertime(); 
                    }
                } else if (currentState === 'OVERTIME') {
                    mainTime++; 
                }
            }

            // 2. çº¯å€’è®¡æ—¶æ¨¡å¼é€»è¾‘
            else if (currentMode === 'COUNTDOWN') {
                if (currentState === 'RUNNING') {
                    mainTime--;
                    totalDuration++;
                    if (mainTime <= 0) {
                        triggerAlarmAndOvertime();
                    }
                } else if (currentState === 'OVERTIME') {
                    mainTime++; 
                    totalDuration++;
                }
            }

            // 3. çº¯æ­£è®¡æ—¶æ¨¡å¼é€»è¾‘
            else if (currentMode === 'STOPWATCH') {
                mainTime++;
                totalDuration++;
                
                if (currentState === 'RUNNING' && mainTime === targetTime) {
                    triggerAlarmAndOvertime(); 
                }
            }

            updateDisplay();
        }

        // --- äº‹ä»¶è§¦å‘ ---
        
        function triggerAlarmAndOvertime() {
            playSound('cycle_end_10s');
            currentState = 'OVERTIME';
            setStyle('OVERTIME');
            
            document.getElementById('status-text').innerText = "ğŸ”” æ—¶é—´åˆ°è¾¾ï¼(ç»§ç»­ç»Ÿè®¡ä¸­)";
            document.getElementById('sub-info').innerText = "æœªç‚¹å‡»ç»“æŸå‰ï¼Œè®¡æ—¶å°†ç»§ç»­...";
            
            document.getElementById('btn-toggle').style.display = 'none'; 
            document.getElementById('btn-end-session').style.display = 'inline-block';
            
            // éœ‡åŠ¨ä¸€ä¸‹ (ä»…ç§»åŠ¨ç«¯)
            if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
        }

        function triggerMicroRest() {
            playSound('micro_start');
            document.body.dataset.prevState = currentState; 
            currentState = 'MICRO_REST';
            setStyle('MICRO_REST');
            eventTimeLeft = document.getElementById('input-micro').value;
            document.getElementById('status-text').innerText = "ğŸ™ˆ é—­çœ¼ä¼‘æ¯";
        }

        function triggerFocusReturn() {
            // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿éŸ³é¢‘ç¯å¢ƒå·²æ¿€æ´»
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            playSound('micro_end'); // è§¦å‘ä¿®å¤åçš„å£°éŸ³
            
            currentState = document.body.dataset.prevState || 'RUNNING';
            setStyle(currentState === 'OVERTIME' ? 'OVERTIME' : 'FOCUS');
            eventTimeLeft = getRandomInterval();
            document.getElementById('status-text').innerText = "ğŸ§  å›åˆ°ä¸“æ³¨";
        }

        function finishSession() {
            stopAllSounds();
            worker.postMessage('stop');
            releaseWakeLock();
            isRunning = false;
            
            let msg = "";
            const m = Math.floor(totalDuration / 60);
            const s = totalDuration % 60;

            if (currentMode === 'RANDOM') {
                alert(`ä¸“æ³¨ç»“æŸï¼\næœ¬æ¬¡æ€»ä¸“æ³¨æ—¶é•¿ï¼š${m}åˆ†${s}ç§’\n\nå»ºè®®ç°åœ¨å»ä¼‘æ¯20åˆ†é’Ÿã€‚`);
            } else {
                alert(`è®¡æ—¶ç»“æŸï¼\næ€»æ—¶é•¿ï¼š${m}åˆ†${s}ç§’`);
            }
            
            resetTimer();
        }

        // --- è¾…åŠ©åŠŸèƒ½ ---

        function updateDisplay() {
            let timeStr = "";
            if (currentState === 'OVERTIME') {
                timeStr = "+" + formatTime(mainTime);
            } else {
                timeStr = formatTime(mainTime);
            }
            document.getElementById('main-timer').innerText = timeStr;

            if (currentMode === 'RANDOM' && (currentState === 'RUNNING' || currentState === 'OVERTIME')) {
                document.getElementById('sub-info').innerText = `éšæœºæ£€æŸ¥: ${eventTimeLeft}ç§’å`;
            } else if (currentState === 'MICRO_REST') {
                document.getElementById('sub-info').innerText = `é—­çœ¼è¿˜å‰©: ${eventTimeLeft}ç§’`;
            } else if (currentState === 'OVERTIME') {
                document.getElementById('sub-info').innerText = "å·²è¿›å…¥é¢å¤–è®¡æ—¶é˜¶æ®µ";
            } else {
                document.getElementById('sub-info').innerText = "ä¸“æ³¨ä¸­...";
            }
        }

        function formatTime(seconds) {
            const m = Math.floor(Math.abs(seconds) / 60).toString().padStart(2, '0');
            const s = (Math.abs(seconds) % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        function getRandomInterval() {
            const min = document.getElementById('input-min').value * 60;
            const max = document.getElementById('input-max').value * 60;
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // --- éŸ³æ•ˆç³»ç»Ÿ ---
        function playTone(freq, type, duration, startTime = 0, volume = 0.1) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.value = freq;
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            const now = audioCtx.currentTime + startTime;
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(volume, now + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.001, now + duration);

            osc.start(now);
            osc.stop(now + duration);
            
            activeOscillators.push(osc);
            setTimeout(() => {
                const idx = activeOscillators.indexOf(osc);
                if (idx > -1) activeOscillators.splice(idx, 1);
            }, (startTime + duration) * 1000 + 100);
        }

        function stopAllSounds() {
            activeOscillators.forEach(osc => { try{osc.stop()}catch(e){} });
            activeOscillators = [];
        }

        function playSound(scene) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            // æ¯æ¬¡æ’­æ”¾æ–°å£°éŸ³å‰ï¼Œåœæ­¢æ—§çš„ï¼ˆé˜²æ­¢å£°éŸ³é‡å æ··ä¹±ï¼‰
            if (scene !== 'cycle_end_10s') stopAllSounds(); 

            switch(scene) {
                case 'micro_start': 
                    playTone(880, 'sine', 0.8, 0, 0.3); // æé«˜éŸ³é‡
                    break;
                case 'micro_end': 
                    // ä¿®æ”¹ï¼šæ›´å“äº®ã€æ›´æ¸…è„†çš„åŒå£°æç¤ºï¼ˆRising Toneï¼‰
                    playTone(600, 'sine', 0.15, 0, 0.4); 
                    playTone(1000, 'sine', 0.4, 0.15, 0.4); 
                    break;
                case 'cycle_end_10s': 
                    stopAllSounds();
                    const melody = [523, 659, 784, 1046]; 
                    for(let i=0; i<20; i++) { 
                        playTone(melody[i%4], 'triangle', 0.4, i*0.5, 0.2);
                    }
                    break;
            }
        }

        // --- æ ·å¼æ§åˆ¶ ---
        function setStyle(style) {
            const body = document.body;
            if (style === 'FOCUS') body.style.backgroundColor = 'var(--bg-focus)';
            else if (style === 'REST') body.style.backgroundColor = 'var(--bg-rest)';
            else if (style === 'MICRO_REST') body.style.backgroundColor = 'var(--bg-rest)';
            else if (style === 'OVERTIME') body.style.backgroundColor = 'var(--bg-overtime)';
            else body.style.backgroundColor = 'var(--bg-focus)';
        }

        function resetTimerUI() {
            stopAllSounds();
            worker.postMessage('stop'); 
            releaseWakeLock();
            isRunning = false;
            currentState = 'IDLE';
            document.getElementById('btn-toggle').innerText = "å¼€å§‹";
            document.getElementById('btn-toggle').style.display = 'inline-block';
            document.getElementById('btn-end-session').style.display = 'none';
            document.getElementById('settings-box').classList.remove('collapsed');
            document.getElementById('btn-settings-toggle').innerText = "æ”¶èµ·è®¾ç½®";
            document.body.style.backgroundColor = 'var(--bg-focus)';
            document.getElementById('sub-info').innerText = "å‡†å¤‡å°±ç»ª";
        }

        function resetTimer() {
            changeMode(); 
        }

        function toggleSettings() {
            const panel = document.getElementById('settings-box');
            const btn = document.getElementById('btn-settings-toggle');
            if (panel.classList.contains('collapsed')) {
                panel.classList.remove('collapsed');
                btn.innerText = "æ”¶èµ·è®¾ç½®";
            } else {
                panel.classList.add('collapsed');
                btn.innerText = "å±•å¼€è®¾ç½®";
            }
        }
    </script>
</body>
</html>
